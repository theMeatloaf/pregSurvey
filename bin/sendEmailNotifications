#!/usr/bin/env node

const test = require('dotenv').config()
const request = require('request');

var pgp = require('pg-promise')();
var connectionString = process.env.DATABASE_URL;
db = pgp(connectionString);

//build out the url...
var API_URL = "https://api:"+process.env.MAILGUN_API_KEY+"@api.mailgun.net/v3/" + process.env.MAILGUN_DOMAIN + "/messages";

//get all users who want email notificaitons and who listen to music....
db.many(`select * from users where notifications_email = true and invite_token is null and (permission_level != -1 or permission_level is null)`)
.then(function (data) {
    for (var i = data.length - 1; i >= 0; i--) {
      delete data[i].password;
      //determine if they need to fill out a survey...
      var date = new Date();
      var dueDate = new Date(data[i].next_survey_date);

      var message = "";
      if (data[i].music_enabled) {
        message = "Heres a reminder to listen to your music today! Log into your account here and take a listen: "+process.env.BASE_URL;
      }

      if (date > dueDate) {
          //need a survey...
         if (data[i].music_enabled) {
            message = message + "\n\nYou also are Due to fill out a survey. Dont forget to complete it soon!"
          } else {
            message = "You are due to fill out a survey for the Maternal Motments Study!\n\nYou can log into your account here to complete it: "+process.env.BASE_URL;
          }
      }

      //send them the email
      request.post(API_URL,
        { form: { from: 'test@test.de', to: data[i].username, subject:'Maternal Moments: Dont forget to listen to your music today!', text:message } },
        function (error, response, body) {
            if (!error && response.statusCode == 200) {
              //do less?...
            } else {
               console.error(response);
            }
        }
      );
    };
  })
  .catch(function (err) {
    console.error(err);
  });